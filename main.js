"use strict";process.on("unhandledRejection",()=>{}),process.on("rejectionHandled",()=>{});const path=require("path"),fs=require("fs"),{app:app,BrowserWindow:BrowserWindow,ipcMain:ipcMain,dialog:dialog,shell:shell,Notification:Notification}=require("electron"),Twig=require("twig"),TwigElectron=require("electron-twig"),puppeteer=require("puppeteer-extra"),puppeteer_default=require("puppeteer"),base_dir=path.join(__dirname),lang_dir=path.join(__dirname,"lang"),data_dir=path.join(__dirname,"data"),tmp_dir=path.join(__dirname,"tmp"),assets_dir=path.join(__dirname,"assets");var axios=require("axios"),FormData=require("form-data");const config=require(path.join(data_dir,"config.json"));(async()=>{const e=new Object({win:!1,chromiums:[],i:async()=>{await e.t.shema(),await e.t.twig_extends(Twig),await e.ex.init(),await e.e.init()},t:{shema:async()=>new Promise(async(t,n)=>{let a=await e.r.shema.select("settings"),i=await e.r.settings.list(),s={};for(var o in a){var r=a[o];void 0!==i[o]&&("integer"===r.type&&(s[o]=Number(i[o])),"string"===r.type&&(s[o]=i[o].toString())),void 0===i[o]&&("integer"===r.type&&(s[o]=Number(r.default)),"string"===r.type&&(s[o]=r.default.toString()))}console.log("ReBuild settings from shema"),await e.r.settings.save(s);let l=await e.r.shema.select("accounts"),c=await e.r.accounts.list();var d=[];c.length&&c.map(e=>{var t={};for(var n in l){var a=l[n];t[n]=a.default,void 0!==e[n]&&("integer"===a.type&&(t[n]=Number(e[n])),"string"===a.type&&(t[n]=e[n].toString()))}d.push(t)}),console.log("ReBuild accounts from shema"),await e.r.accounts.save(d),fs.writeFileSync(path.join(data_dir,"accounts.rezerv.json"),JSON.stringify(d,null,4)),t(!0)}).catch(e=>{console.log("ReBuild groups from shema error",e)}),twig_extends:async t=>new Promise((n,a)=>{console.log("Twig_extends load"),t.extendFilter("get_numeric",function(e){return void 0===e||null===e?"":e.replace(/[^+\d]/g,"")}),t.extendFunction("climetime",function(t){var n="00:00";if(void 0!==t.climetime&&t.climetime>0){let a=Number(e.h.time())-Number(t.climetime),i=e.h.timer_convert(a);n=`${i.h}:${i.m}:${i.s}`}return n}),t.extendFilter("num2word",function(t,n){return e.h.num2word(t,n)}),t.extendFilter("view_date",function(e,t="d,m,y,t"){let n=["Января","Февраля","Марта","Апреля","Мая","Июня","Июля","Августа","Сентября","Октября","Ноября","Декабря"];var a=t[0].split(","),i="",s=new Date(e),o={d:s.getDate(),m:s.getMonth(),y:s.getFullYear(),h:s.getHours(),i:s.getMinutes()};if(-1!=a.indexOf("d")&&(i+=o.d<10?"0"+o.d.toString():o.d),-1!=a.indexOf("m")&&(i+=" "+n[o.m]),-1!=a.indexOf("t")){i+=" в "+(o.h>9?o.h:"0"+o.h.toString())+":"+(o.i>9?o.i:"0"+o.i.toString())}if(-1!=a.indexOf("y")){i+=", "+o.y}return i}),t.extendFunction("print_r",function(...e){const t=[...e],n=this;let a=0,i="";const s=function(e){let t="";for(;e>0;)e--,t+="  ";return t},o=function(e){i+=s(a),"object"==typeof e?r(e):"function"==typeof e?i+="function()\n":"string"==typeof e?i+="string("+e.length+') "'+e+'"\n':"number"==typeof e?i+="number("+e+")\n":"boolean"==typeof e&&(i+="bool("+e+")\n")},r=function(e){let t;if(null===e)i+="NULL\n";else if(void 0===e)i+="undefined\n";else if("object"==typeof e){i+=s(a)+typeof e,a++,i+="("+function(e){let t,n=0;for(t in e)Object.hasOwnProperty.call(e,t)&&n++;return n}(e)+") {\n";for(t in e)Object.hasOwnProperty.call(e,t)&&(i+=s(a)+"["+t+"]=> ",o(e[t]));i+=s(--a)+"}\n"}else o(e)};return 0===t.length&&t.push(n.context),t.forEach(e=>{r(e)}),"<pre>"+i+"<pre>"}),t.extendFilter("array_column",function(e,t){if(void 0!==e&&null!==e)return e.map(e=>e[t])}),n(!0)}).catch(e=>{console.log("(DevMode) settings.dist reBuild error",e)})},r:{accounts:{list:async()=>{return JSON.parse(fs.readFileSync(path.join(data_dir,"accounts.json"),"utf8"))},save:async(e,t="accounts")=>{fs.writeFileSync(path.join(data_dir,`${t}.json`),JSON.stringify(e,null,4))},select:async t=>{return(await e.r.accounts.list()).find(e=>e.id===t)},insert:async t=>{let n=await e.r.accounts.list();n.push(t),e.r.accounts.save(n)},delete:async t=>{let n=(await e.r.accounts.list()).filter(e=>e.id.toString()!==t.toString());return e.r.accounts.save(n),n},update:async(t,n)=>{let a=(await e.r.accounts.list()).map(e=>(e.id===t&&(e=Object.assign(e,n)),e));e.r.accounts.save(a)}},settings:{list:async()=>{return require(path.join(data_dir,"settings.json"))},save:(e,t="settings")=>{fs.writeFileSync(path.join(data_dir,`${t}.json`),JSON.stringify(e,null,4))},select:async t=>{let n=await e.r.settings.list();return!!n[t]&&n[t]},update:async t=>{let n=await e.r.settings.list(),a=Object.assign(n,t);e.r.settings.save(a)}},shema:{list:async()=>{return require(path.join(data_dir,"shema.json"))},select:async t=>{let n=await e.r.shema.list();return!!n[t]&&n[t]}},languages:{list:()=>require(path.join(lang_dir,"langs.json")),select:async e=>new Promise((t,n)=>{t(require(path.join(lang_dir,e)))}).catch(t=>{console.log("lang select error",e)}),get:async(t="russian")=>{let n=e.r.settings.select("lang");return"russian"!==t&&(n=t),console.log("Select lang",n),await e.r.languages.select(n)}}},h:{timer_convert:function(e){if(e=function(e){return!!(e=e||!1)&&(e>0&&e)}(e)){var t=e%60,n=(e-t)/60,a=n%60,i=(n=(n-a)/60)%24,s=(n-i)/24;return{d:s<10?"0"+s:s,h:i<10?"0"+i:i,m:a<10?"0"+a:a,s:t<10?"0"+t:t}}return!1},clear_one_array:function(e={},t=!1){let n={};if(!1===t)n=e;else{let i={...e};for(var a in t){let e=t[a];void 0!==i[e]&&(n[e]=i[e])}}return n},clear_two_array:function(e=[],t=!1){let n=this,a=[];if(!1!==t){for(let i in e){let s={...e[i]},o=n.clear_one_array(s,t);a.push(o)}return a}a=e},num2word:function(e,t){if(void 0!==e&&null!==e){var n=e,a=Number(t[0]),i="-";return(a%=100)>19&&(a%=10),"1"==a.toString()&&(i=n[0]),-1!=["2","3","4"].indexOf(a.toString())&&(i=n[1]),"-"===i&&(i=n[2]),i}},time:function(){return Math.round((new Date).getTime()/1e3)},get_id:(e,t=1)=>{let n=!1,a=t;do{if(-1==e.indexOf(a)){n=a;break}a++}while(a<1e9);return n},sleep:e=>new Promise(t=>setTimeout(t,e))},e:{init:()=>new Promise((t,n)=>{app.requestSingleInstanceLock()?(app.on("second-instance",(t,n,a)=>{e.win&&(e.win.isMinimized()&&e.win.restore(),e.win.focus())}),app.on("window-all-closed",async()=>{"darwin"!==process.platform&&app.quit(),e.chromiums.length>0&&e.chromiums.map(async e=>{(await e.pages()).forEach(async e=>{await e.isClosed()||await e.close()})})}),app.on("ready",e.e.create)):app.quit(),t(!0)}).catch(e=>{console.log("Electron run error",e)}),create:()=>new Promise(async(t,n)=>{let a=await e.r.settings.list();void 0===a.lang&&(a.lang="english");let i=await e.r.languages.list(),s=await e.r.languages.select(a.lang);e.win=new BrowserWindow({minWidth:config.min_width,minHeight:config.min_height,width:config.min_width,height:config.min_height,icon:path.join(base_dir,config.icon_path),webPreferences:{nodeIntegration:!0,contextIsolation:!1,enableRemoteModule:!0}}),"on"==config.dev_tools&&e.win.openDevTools(),e.win.setMenu(null),e.win.loadFile("index.twig"),TwigElectron.view={settings:a,lang:s,langs:i},e.win.on("close",t=>{e.win=null}),await e.e.ips(),t(!0)}),ips:async()=>{ipcMain.handle("tpl",async(e,t)=>{console.log("ipcMain tpl",t.tplname);let n=t.tplname;return await new Promise((e,t)=>{fs.open(path.join(base_dir,n),"r",function(t,a){t?e(path.join(base_dir,n)):fs.readFile(a,{encoding:"utf-8"},function(t,n){t||e(n)})})})}),ipcMain.handle("lang",async(t,n)=>{console.log("ipcMain lang");let a=await e.r.settings.select("lang");return await e.r.languages.select(a)}),ipcMain.handle("settings",async function(t,n){return console.log("ipcMain settings"),await e.r.settings.list()}),ipcMain.handle("accounts",async(t,n)=>(console.log("ipcMain accounts"),await e.r.accounts.list())),ipcMain.on("pvu_run",async(t,n)=>{let a=await e.r.accounts.select(n);e.c.run_pvu(a)}),ipcMain.on("link",(e,t)=>{console.log("ipcMain link openExternal",t),shell.openExternal(t)}),ipcMain.on("download",async(e,t)=>{console.log("ipcMain download show dialog for",t.fileName),dialog.showSaveDialog({defaultPath:"~/"+t.fileName}).then(e=>{console.log(`ipcMain download ${t.fileName} save to`,e.filePath),fs.writeFile(e.filePath,t.fileData,e=>{})}).catch(e=>{console.log(`ipcMain download ${t.fileName} catch`,e)})}),ipcMain.on("download_file",async(e,t)=>{console.log("ipcMain download_file show dialog for",t.fileName),dialog.showSaveDialog({defaultPath:"~/"+t.fileName,filters:[{name:"Мои файлы",extensions:t.fileExt},{name:"Все файлы",extensions:["*"]}]}).then(e=>{console.log(`ipcMain download_file ${t.fileName} save to`,e.filePath),fs.writeFile(e.filePath,fs.readFileSync(path.join(base_dir,t.filePath)),e=>{})}).catch(e=>{console.log(`ipcMain download_file ${t.fileName} catch`,e)})}),ipcMain.handle("save_settings",async(t,n)=>{let a={status:"error"},i=await e.r.settings.list(),s=await e.r.languages.select(i.lang),o=await e.r.shema.select("settings");try{let t={};n.map(e=>{if(void 0!==o[e.name]){let n=e.value;"integer"===o[e.name].type&&(n=+e.value),t[e.name]=n}}),console.log("ipcMain save_settings update",t),await e.r.settings.update(t),a={status:"success",message:s.pages.settings.saveOK}}catch(e){console.log("ipcMain save_settings catch",e)}return a}),ipcMain.handle("account_remove",async(t,n)=>(console.log("ipcMain account_remove run",n),await e.r.accounts.delete(n))),ipcMain.handle("account_edit",async(t,n)=>{console.log("ipcMain group_edit run",n);let a=await e.r.settings.list(),i=await e.r.languages.select(a.lang),s={status:"error",message:i.errors.error_message},o=await e.r.shema.select("accounts"),r=(await e.r.accounts.list()).map(e=>+e.id),l={};for(let e in o)if(Object.hasOwnProperty.call(o,e))try{let t=o[e],a=n.find(t=>t.name===e);if(void 0!==a.value){let n=a.value.toString();"integer"===t.type&&(0==+a.value&&(n=0),n=Number(a.value)),l[e]=n}}catch(e){}return 0==Number(l.id)?(l.id=e.h.get_id(r),console.log("ipcMain group_edit insert",l.id,l),await e.r.accounts.insert(l),await e.t.shema(),s={status:"success",message:i.pages.accounts.created_message}):(console.log("ipcMain group_edit update",l.id,l),await e.r.accounts.update(+l.id,l),s={status:"success",message:i.pages.accounts.edited_message}),s})},notify_list:[],only_notify:(t=!1,n="",a="")=>{var i=!0;if(!1!==t){void 0!==e.e.notify_list.find(e=>e.keytype===t)&&(i=!1)}!0===i&&(e.e.notify_list.push({keytype:t,timestamp:e.h.time()}),setTimeout(()=>{e.e.notify_list=e.e.notify_list.filter(e=>e.keytype!==t)},216e5),new Notification({title:n,body:a}).show())}},ex:{status:!1,init:async()=>new Promise((t,n)=>{console.log("ExpressJS Run");try{const n=require("express"),a=n();a.set("views",assets_dir),a.set("view engine","twig"),a.use(n.json({limit:"50mb"})),a.use(n.urlencoded({limit:"50mb",extended:!1})),a.use(n.static(assets_dir));const i=n.urlencoded({extended:!1});a.get("/",e.ex.pages.index),a.get("/pvuinfo",e.ex.pages.pvuinfo),a.post("/api/:method",i,e.ex.pages.api),a.use(function(e,t,n){t.status(404).end("404 Not found")}),a.listen(config.port,()=>{e.ex.status=!0,t(!0)})}catch(e){console.log("ExpressJS ERROR, Please run file: install.bat or run command: npm install express --save"),console.log("Запустите файл install.bat")}}).catch(e=>{console.log("ExpressJS Run error",e)}),pages:{index:(e,t,n)=>{t.render("index.twig",{config:config,query:e.query,content:"layouts/homepage.twig"})},pvuinfo:(e,t,n)=>{t.render("index.twig",{config:config,query:e.query,content:"layouts/pvuinfo.twig"})},api:async(t,n,a)=>{let i="success",s="ok",o={},r=!1,l=!1;if(void 0!==t.body.header){o=JSON.parse(t.body.json_data);let a=await e.r.accounts.list();if(void 0!==t.body.header&&void 0!==(l=a.find(e=>e.name===t.body.header)).id&&(r=Number(l.id)),!1===r)i="error",s="account not isset from list";else{if("give"===t.params.method&&e.win.webContents.send("meta_give",{account_id:l.id,data:o}),"tools"===t.params.method&&(e.r.accounts.update(r,{tool_sPot:+o.spot,tool_bPot:+o.bpot,tool_water:+o.water,tool_crow:+o.crow,tool_green:+o.green}),e.win.webContents.send("meta_tools",{account_id:l.id,data:o})),"sunflowers"===t.params.method&&(e.r.accounts.update(r,{inv_mama:+o.mama}),e.win.webContents.send("inv_plants_0",{account_id:l.id,data:+o.mama})),"plants_1_count"===t.params.method&&(e.r.accounts.update(r,{inv_plants_1:+o.plants_1_count}),e.win.webContents.send("inv_plants_1",{account_id:l.id,data:+o.plants_1_count})),"plants_2_count"===t.params.method&&(e.r.accounts.update(r,{inv_plants_2:+o.plants_2_count}),e.win.webContents.send("inv_plants_2",{account_id:l.id,data:+o.plants_2_count})),"stats"===t.params.method){if(e.r.accounts.update(r,{harvest:0!=+o.harv?"on":"off",seeds:0!=+o.seeds?"on":"off",kapust:+o.kapusted,pvu_balance:+o.pvuBalance,le_balance:+o.leBalance}),0!=+o.harv){c=`${l.id}harvest`;e.e.only_notify(c,`${l.id}. ${l.name} -> Время собирать урожай`,"")}if(0!=+o.seeds){c=`${l.id}seeds`;e.e.only_notify(c,`${l.id}. ${l.name} -> Выпало семечко из растения`,"")}e.win.webContents.send("meta_stats",{account_id:l.id,data:o})}if("plants"===t.params.method){e.r.accounts.update(r,{plants:o}),e.win.webContents.send("meta_plants",{account_id:l.id,data:o});let t=!1,n=!1,a=!1;if(o.map(e=>{!1!==e.needWater&&(t=!0),!1!==e.hasSeed&&(n=!0),void 0!==e.crow&&!0===e.crow&&(a=!0)}),t){c=`${l.id}water`;e.e.only_notify(c,`${l.id}. ${l.name} -> Необходимо полить растение`,"")}if(n){c=`${l.id}seed`;e.e.only_notify(c,`${l.id}. ${l.name} -> Необходимо забрать семечко`,"")}if(a){var c=`${l.id}crow`;e.e.only_notify(c,`${l.id}. ${l.name} -> Необходимо согнать ворону`,"")}}}n.header("Access-Control-Allow-Origin","*"),n.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),n.json({header:t.body.header,account_id:r,data:o,account:l,acc_id:r})}try{n.header("Access-Control-Allow-Origin","*").status(200).json({status:i,message:s,post_data:o})}catch(e){}}}},c:{run_pvu:async t=>{let n=["--start-maximized","--no-sandbox","--disable-setuid-sandbox","--user-agent="+t.user_agent,"--disable-background-timer-throttling","--disable-backgrounding-occluded-windows","--disable-renderer-backgrounding"];"on"===t.proxy&&n.push(`--proxy-server=${t.proxy_host}:${t.proxy_port}`),puppeteer_default.launch({userDataDir:path.join(tmp_dir+`/browser_cache_${t.name}`),headless:!1,defaultViewport:null,ignoreHTTPSErrors:!0,ignoreDefaultArgs:["--disable-extensions","--enable-automation"],args:n}).then(async n=>{e.chromiums.push(n);const a=await n.newPage();await a.setUserAgent(t.user_agent),"on"===t.proxy&&await a.authenticate({username:t.proxy_username,password:t.proxy_password}),await a.goto("https://marketplace.plantvsundead.com/login#/farm/",{waitUntil:"networkidle2"});for(let e of await n.pages())"about:blank"===await e.url()&&await e.close();await a.waitForTimeout(2e3)}).catch(e=>{console.log(`${t.name} -> puppeteer.launch -> Cacth`,e)})}}});e.i()})();